name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '14'

    - name: Install dependencies
      run: npm install

    - name: Build Docker image
      run: |
        docker build -t blacorpheus/reverse-ip-app:latest .

    - name: Login to Docker Hub
      run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

    - name: Push Docker image
      run: docker push blacorpheus/reverse-ip-app:latest

  deploy:
    runs-on: ubuntu-latest   # Correct indentation here
    needs: build
    steps:
    - name: Set up Kubernetes
      uses: azure/setup-kubectl@v1
      with:
        version: 'latest'

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1 
        #role-to-assume: arn:aws:iam::884434650011:role/eks-project
        #role-session-name: GitHubActionsEKS

    #- name: Install kubectl
     # run: |
      #  curl -o kubectl https://amazon-eks.s3.us-west-2.amazonaws.com/1.21.2/2021-07-05/bin/linux/amd64/kubectl
       # chmod +x ./kubectl
        #sudo mv ./kubectl /usr/local/bin/

    - name: Update kubeconfig
      run: |
        aws eks update-kubeconfig --name eks-project --region us-east-1

    - name: Display Kubeconfig
      run: cat ~/.kube/config

    - name: Test Kubernetes Access
      run: kubectl get nodes

    - name: Deploy to EKS using Helm
      run: |
        helm repo add stable https://charts.helm.sh/stable
        helm repo update
        helm upgrade --install reverse-ip-app ./reverse-ip-app


